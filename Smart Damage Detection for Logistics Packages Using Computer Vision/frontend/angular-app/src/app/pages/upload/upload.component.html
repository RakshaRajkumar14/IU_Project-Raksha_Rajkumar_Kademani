<!--
Upload Component Template - Complete with Explainability
Author: RakshaRajkumar14
Date: 2025-11-16 14:41:18 UTC
-->

<div class="upload-container">
  <!-- Header with User Info -->
  <div class="upload-header glass-effect">
    <div class="header-content">
      <h2>üì¶ Smart Package Inspection</h2>
      <div class="user-info" *ngIf="currentUser">
        <span class="user-icon">üë§</span>
        <span class="user-name">{{ currentUser.full_name || currentUser.username }}</span>
      </div>
    </div>
  </div>

  <!-- Upload Zone (when no image) -->
  <div class="image-display glass-effect" *ngIf="!uploadedImage && !isProcessing">
    <div class="upload-zone" 
         (click)="fileInput.click()" 
         (dragover)="onDragOver($event)" 
         (drop)="onDrop($event)">
      <div class="upload-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
        </svg>
      </div>
      <h3>Upload Package Image</h3>
      <p>Drag & drop or click to select an image for AI damage detection</p>
      <button class="upload-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
        </svg>
        Choose File
      </button>
      <input #fileInput type="file" accept="image/*" (change)="onFileSelected($event)" style="display: none;">
    </div>
  </div>

  <!-- Processing Loader -->
  <div class="image-display glass-effect" *ngIf="isProcessing">
    <div class="processing-loader">
      <div class="ai-scanner">
        <div class="scan-line"></div>
      </div>
      <h3>ü§ñ AI Processing...</h3>
      <p>Analyzing with YOLOv8 Model</p>
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="processingProgress"></div>
      </div>
      <div class="progress-text">{{ processingProgress }}%</div>
    </div>
  </div>

  <!-- Detection Results -->
  <div class="content-grid" *ngIf="uploadedImage && !isProcessing">
    <!-- Left: Image Display -->
    <div class="inspection-section">
      <div class="image-display glass-effect">
        <!-- Detection Badge -->
        <div class="detection-badge" *ngIf="hasDetections">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
          </svg>
          {{ detectionResult?.total_damages }} damages detected
        </div>

        <!-- View Tabs -->
        <div class="view-tabs">
          <button class="tab-btn" 
                  [class.active]="currentView === 'original'" 
                  (click)="currentView = 'original'">
            Original
          </button>
          <button class="tab-btn" 
                  [class.active]="currentView === 'annotated'" 
                  (click)="currentView = 'annotated'" 
                  *ngIf="detectionResult?.annotated_image_url">
            üéØ Detection
          </button>
          <button class="tab-btn" 
                  [class.active]="currentView === 'gradcam'" 
                  (click)="currentView = 'gradcam'" 
                  *ngIf="detectionResult?.gradcam_url">
            üî• GradCAM
          </button>
          <button class="tab-btn" 
                  [class.active]="currentView === 'shap'" 
                  (click)="currentView = 'shap'" 
                  *ngIf="detectionResult?.shap_url">
            üìä SHAP
          </button>
        </div>

        <!-- Image -->
        <img [src]="getDisplayImage()" alt="Package inspection" class="package-image">

        <!-- Image Info -->
        <div class="image-info">
          <span>üìê {{ detectionResult?.image_width }}x{{ detectionResult?.image_height }}px</span>
          <span>‚è±Ô∏è {{ detectionResult?.inference_time_ms }}ms</span>
          <span>üìÖ {{ detectionResult?.timestamp | date:'short' }}</span>
        </div>
      </div>

      <!-- Explainability Section -->
      <div class="explainability-section glass-effect" *ngIf="hasDetections">
        <h3 class="section-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="16" x2="12" y2="12"/>
            <line x1="12" y1="8" x2="12.01" y2="8"/>
          </svg>
          Explainability AI
        </h3>
        <div class="explainability-cards">
          <div class="explainability-card">
            <div class="card-icon gradcam">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
            </div>
            <h4>GradCAM</h4>
            <p>Visual attention heatmap showing AI focus regions</p>
            <div class="card-actions">
              <button class="view-btn" (click)="currentView = 'gradcam'" *ngIf="detectionResult?.gradcam_url">
                View Heatmap
              </button>
              <button class="s3-btn" (click)="viewOnS3('gradcam')" *ngIf="detectionResult?.gradcam_s3_url">
                ‚òÅÔ∏è S3
              </button>
            </div>
          </div>
          
          <div class="explainability-card">
            <div class="card-icon shap">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"/>
                <path d="M3 9h18M9 21V9"/>
              </svg>
            </div>
            <h4>SHAP Analysis</h4>
            <p>Feature importance for detection decisions</p>
            <div class="card-actions">
              <button class="view-btn" (click)="currentView = 'shap'" *ngIf="detectionResult?.shap_url">
                View Analysis
              </button>
              <button class="s3-btn" (click)="viewOnS3('shap')" *ngIf="detectionResult?.shap_s3_url">
                ‚òÅÔ∏è S3
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Package Assessment -->
      <div class="assessment-section glass-effect" *ngIf="detectionResult">
        <h3 class="section-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
          </svg>
          Package Assessment
        </h3>

        <div class="package-info">
          <div class="info-row">
            <span class="info-label">üì¶ Tracking Code:</span>
            <span class="info-value">{{ detectionResult.tracking_code }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">üìä Status:</span>
            <span class="info-value status-badge" [ngClass]="detectionResult.status">
              {{ detectionResult.status | uppercase }}
            </span>
          </div>
          <div class="info-row">
            <span class="info-label">üë§ Inspector:</span>
            <span class="info-value">{{ detectionResult.inspector }}</span>
          </div>
        </div>

        <div class="severity-grid" *ngIf="hasDetections">
          <div class="severity-card severe">
            <div class="severity-number">{{ detectionResult.severity_counts.severe }}</div>
            <div class="severity-label">Severe</div>
          </div>
          <div class="severity-card moderate">
            <div class="severity-number">{{ detectionResult.severity_counts.moderate }}</div>
            <div class="severity-label">Moderate</div>
          </div>
          <div class="severity-card minor">
            <div class="severity-number">{{ detectionResult.severity_counts.minor }}</div>
            <div class="severity-label">Minor</div>
          </div>
        </div>

        <div class="action-buttons">
          <button class="action-btn primary" (click)="downloadReport()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
            </svg>
            Download Report (JSON)
          </button>
          <button class="action-btn secondary" (click)="exportCSV()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
            </svg>
            Export CSV
          </button>
          <button class="action-btn secondary" (click)="reset()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 12a9 9 0 019-9 9.75 9.75 0 016.74 2.74L21 8"/>
              <path d="M21 3v5h-5"/>
            </svg>
            New Scan
          </button>
        </div>
      </div>
    </div>

    <!-- Right: Damage Analysis -->
    <div class="analysis-section" *ngIf="hasDetections">
      <div class="analysis-card glass-effect">
        <div class="card-header">
          <h2>Damage Analysis</h2>
          <span class="damage-count" [ngClass]="detectionResult?.status">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
            </svg>
            {{ detectionResult?.total_damages }}
          </span>
        </div>

        <!-- Summary Cards -->
        <div class="summary-cards">
          <div class="summary-card severe">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
            </svg>
            <div class="summary-info">
              <div class="summary-number">{{ detectionResult?.severity_counts.severe }}</div>
              <div class="summary-label">Severe</div>
            </div>
          </div>
          <div class="summary-card moderate">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
            </svg>
            <div class="summary-info">
              <div class="summary-number">{{ detectionResult?.severity_counts.moderate }}</div>
              <div class="summary-label">Moderate</div>
            </div>
          </div>
          <div class="summary-card minor">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
              <line x1="9" y1="9" x2="9.01" y2="9"/>
              <line x1="15" y1="9" x2="15.01" y2="9"/>
            </svg>
            <div class="summary-info">
              <div class="summary-number">{{ detectionResult?.severity_counts.minor }}</div>
              <div class="summary-label">Minor</div>
            </div>
          </div>
        </div>

        <!-- Detected Damages List -->
        <div class="damages-header">
          <h3>Detected Damages</h3>
          <span class="damages-sort">By Confidence</span>
        </div>

        <div class="damages-list">
          <div class="damage-item" *ngFor="let damage of detectionResult?.detections">
            <div class="damage-info">
              <div class="damage-icon" [style.color]="damage.color">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                </svg>
              </div>
              <div class="damage-details">
                <div class="damage-name">{{ damage.class_name }}</div>
                <div class="damage-meta">
                  <span class="severity-badge" [ngClass]="damage.severity">
                    {{ damage.severity | titlecase }}
                  </span>
                  <span class="confidence-text">{{ (damage.score * 100).toFixed(1) }}%</span>
                </div>
              </div>
            </div>
            <div class="confidence-bar">
              <div class="confidence-fill" 
                   [style.width.%]="damage.score * 100"
                   [style.background]="damage.color">
              </div>
            </div>
            <div class="damage-dimensions">{{ damage.dimensions }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- No Damages Found -->
    <div class="analysis-section" *ngIf="!hasDetections && detectionResult">
      <div class="analysis-card glass-effect no-damage">
        <div class="success-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
        </div>
        <h3>‚úÖ No Damage Detected</h3>
        <p>This package passed inspection successfully!</p>
        <div class="package-status-ok">
          <span>Status: PASSED</span>
          <span>Tracking: {{ detectionResult.tracking_code }}</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Minimal AI Decision Modal -->
<div class="modal-overlay" *ngIf="showExplainabilityModal" (click)="closeModal()">
  <div class="ai-decision-card" (click)="$event.stopPropagation()">
    <button class="close-btn" (click)="closeModal()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>
    
    <div class="status-icon" [ngClass]="hasDetections ? 'reject' : 'accept'">
      <svg *ngIf="!hasDetections" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
        <polyline points="20 6 9 17 4 12"/>
      </svg>
      <svg *ngIf="hasDetections" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </div>
    
    <h2 class="decision-title" [ngClass]="hasDetections ? 'reject' : 'accept'">
      {{ hasDetections ? 'CANNOT DELIVER' : 'READY TO DELIVER' }}
    </h2>
    
    <p class="damage-info" *ngIf="hasDetections">
      {{ detectionResult?.total_damages }} damage(s) detected
    </p>
    
    <p class="decision-text">
      {{ getAIDecisionText() }}
    </p>
  </div>
</div>